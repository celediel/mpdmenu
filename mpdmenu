#!/bin/bash

dmenu="dmenu -p"

all_name='[ALL]'
mode=artist

controls="󰐎 toggle
 play
 pause
󰒭 next
󰒮 prev
󰒟 random
󰕇 repeat"

show_help() {
    me=$(basename $0)
    printf "$me\ndmenu frontend to mpd\n\n"
    printf "USAGE:\n\t$me [FLAGS]\n"
    printf "FLAGS:\n"
    printf "\t-h\t\tPrints help information\n"
    printf "\t-a\t\tArtist mode\n"
    printf "\t-A\t\tAlbum artist mode\n"
    printf "\t-b\t\tAlbum mode\n"
    printf "\t-p\t\tPlaylist mode\n"
    printf "\t-P\t\tPlaylists mode\n"
    printf "\t-c\t\tControl mode\n"
    printf "\n"
}

make_status() {
    local nowplaying=$(mpc status | head -n1)
    local random_status=$(mpc status | tail -n1 | grep -Eo "random: (on|off)" | cut -d':' -f2 | xargs)
    local repeat_status=$(mpc status | tail -n1 | grep -Eo "repeat: (on|off)" | cut -d':' -f2 | xargs)
    local status_status=$(mpc status | head -n2 | tail -n1 | grep -Eo "\[\w+\]")
    local random=$([ "$random_status" == "on" ] && echo "󰒝" || echo "󰒞")
    local repeat=$([ "$repeat_status" == "on" ] && echo "󰑖" || echo "󰑗")
    local status=$([ "$status_status" == "[playing]" ] && echo "" || echo "")

    printf "$status $random $repeat $nowplaying"
}

d_artist() {
    mpc list artist | sort -f | $dmenu "artist > " "${dmenu_args[@]}"
}

d_albumartist() {
    mpc list albumartist | sort -f | $dmenu "album artist > " "${dmenu_args[@]}"
}

d_album() {
    local artist="$1"
    local albums

    mapfile -t albums < <(mpc list album artist "$artist")
    if (( ${#albums[@]} > 1 )) ; then
        {
            printf '%s\n' "$all_name"
            printf '%s\n' "${albums[@]}" | sort -f
        } | $dmenu "albums by $artist > " "${dmenu_args[@]}"
    else
        # We only have one album, so just use that.
        printf '%s\n' "${albums[0]}"
    fi
}

# TODO: refactor to repeat less code
d_albuma() {
    local artist="$1"
    local albums

    mapfile -t albums < <(mpc list album albumartist "$artist")
    if (( ${#albums[@]} > 1 )) ; then
        {
            printf '%s\n' "$all_name"
            printf '%s\n' "${albums[@]}" | sort -f
        } | $dmenu "albums by $artist > " "${dmenu_args[@]}"
    else
        # We only have one album, so just use that.
        printf '%s\n' "${albums[0]}"
    fi
}

d_playlist() {
    local format="%position% %title% \[%time%\]"
    local extra_format="(%artist% - %album%)"
    local track
    local num_extras

    # If all tracks are from the same artist and album, no need to display that
    num_extras=$(mpc playlist -f "$extra_format" | sort | uniq | wc -l)
    (( num_extras == 1 )) || format+=" $extra_format"

    track=$(mpc playlist -f "$format" | $dmenu "$(make_status) > " "${dmenu_args[@]}")
    printf '%s' "${track%% *}"
}

d_control() {
    printf "${controls[@]}" | $dmenu "$(make_status) > " "${dmenu_args[@]}" | cut -d' ' -f2
}

i=2

for arg do
    if [[ $arg == :: ]]; then
        dmenu_args=( "${@:$i}" )
        break
    fi

    case "$arg" in
        -h) show_help && exit 0 ;;
        -a) mode=artist ;;
        -A) mode=albumartist ;;
        -b) mode=album ;;
        -p) mode=playlist ;;
        -P) mode=playlists ;;
        -c) mode=control ;;
    esac

    let i++
done

case "$mode" in
    artist)
        artist=$(d_artist)
        [[ $artist ]] || exit 1

        album=$(d_album "$artist")
        [[ $album ]] || exit 2

        mpc clear >/dev/null
        if [[ $album == "$all_name" ]]; then
            mpc find artist "$artist" | sort | mpc add
        else
            mpc find artist "$artist" album "$album" | sort | mpc add
        fi

        mpc play >/dev/null
    ;;
    albumartist)
        artist=$(d_albumartist)
        [[ $artist ]] || exit 1

        album=$(d_albuma "$artist")
        [[ $album ]] || exit 2

        mpc clear >/dev/null
        if [[ $album == "$all_name" ]]; then
            mpc find albumartist "$artist" | sort | mpc add
        else
            mpc find albumartist "$artist" album "$album" | sort | mpc add
        fi

        mpc play >/dev/null
    ;;
    album)
        album=$(mpc list album | $dmenu "albums > ")
        [[ $album ]] || exit 1

        mpc clear >/dev/null
        mpc find album "$album" | sort | mpc add
        mpc play >/dev/null
    ;;
    playlist)
        mpc play "$(d_playlist)" >/dev/null
    ;;
    playlists)
        playlist=$(mpc lsplaylists | $dmenu "playlists > ")
        [[ $playlist ]] || exit 1
        mpc clear >/dev/null
        mpc load $playlist >/dev/null
    ;;
    control)
        mpc "$(d_control)" >/dev/null
    ;;
esac
